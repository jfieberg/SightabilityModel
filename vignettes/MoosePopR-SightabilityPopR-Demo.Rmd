---
title: MoosePopR and SightabilityPopR Demonstration"
author: "Carl james Schwarz"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MoosePopR and SightabilityPopR Demonstration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  % \VignetteDepends{car, ggplot2, kableExtra, plyr, readxl}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(width=200)

library(car)
library(ggplot2)
library(kableExtra)
library(plyr)
library(readxl)
library(reshape2)
library(SightabilityModel)


```

# Introduction

This document illustrates how to use the *MoosePopR()* and *SightabilityPopR()* functions to r
eplace the *MoosePop* and *AerialSurvey* programs.
The results from a 2018 survey of moose will be used for illustrative purposes.

## Survey protocol
The survey area is stratified into three strata corresponding to *low*, *medium*, and *high* density
depending on past years results, vegetation cover, and other attributes.

Within each stratum, the survey area is divided into *blocks*. Each block is defined
by considering ecological factors such as elevation, type of vegetation, etc. 

A simple random sample of blocks is selected from each stratum, i.e. each block is selected with equal probability
within each stratum. The number of block to select from each stratum is determined using different allocation methods.
Some selected blocks could not be surveyed due to bad weather etc. These missed blocks are assumed to be missing 
completely at random (MCAR) within each stratum, i.e. the missingness is unrelated to the response or any other covariate.
The impact of MCAR is a reduction in sample size in each stratum (with increased uncertainty in the estimates
for each stratum compared to 
a survey with no missing blocks), but no biases are introduced.

When a block is surveyed, moose are observed in groups. When a group is identified, a count of the number
of moose is made separated by age (adult, juvenile, calves) and sex (bull or cow).

Not all moose can be counted due to visibility concerns. A previous sightability study (**conducted when**) is used
to correct the observed count of moose based on a categorical vegetation cover variable with five classes.

This is a stratified random sampling design where the sampling unit is the *block* surveyed in each stratum
and the observational unit is a group of moose. The observations on groups are pseudo-replicates
and must be treated as observations within a cluster (being the block). 

This document will illustrate how to estimate the total number and density of moose (in various classes) and 
the ratio of types of moose (e.g. bulls to cow ratio) without and with correcting for sightability. The
estimates are compared to those generated by the *MoosePop* program (no correction for sightability) and the
*AerialSurvey* package (correction for sightability).

# Data input

Data input consists of several datasets placed into an Excel workbook using different
worksheets for the different information. 

## Moose data
This consists of information on group of moose observed in a selected blocks.


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Get the actual survey data
dir(system.file("extdata", package = "SightabilityModel"))

survey.data <- readxl::read_excel(system.file("extdata", "SampleMooseSurveyData.xlsx", package = "SightabilityModel", mustWork=TRUE),
                                  sheet="BlockData",
                                  skip=1,.name_repair="universal")
```

Variable names for the counts are somewhat arbitrary.
Notice how *R* converts the column names from the Excel workbook to 
to proper *R* variable names. These (modified) variable names will be used to identify
the quantities to be estimated so simpler names are easier to use than more complicated names.
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Check the variable names in the input data
names(survey.data)
```

Missing values in the count fields are assume to be zeros and a zero value must be 
substituted for the missing values. 

```{r echo=TRUE, message=FALSE, warning=FALSE}
# convert all NA in moose counts to 0
survey.data$Bulls          [ is.na(survey.data$Bulls)         ] <- 0
survey.data$Lone.Cows      [ is.na(survey.data$Lone.Cows)     ] <- 0
survey.data$Cow.W.1...calf [ is.na(survey.data$Cow.W.1...calf)] <- 0
survey.data$Cow.W.2.calves [ is.na(survey.data$Cow.W.2.calves)] <- 0
survey.data$Lone...calf    [ is.na(survey.data$Lone...calf)   ] <- 0
survey.data$Unk.Age.Sex    [ is.na(survey.data$Unk.Age.Sex)   ] <- 0
#head(survey.data)
```


We check that the *NMoose* is computed properly by comparing the recorded total number of moose with
a computed total number of moose. 

```{r echo=TRUE, message=TRUE, warning=TRUE}
# check the total moose ead in vs computed number
survey.data$myNMoose <- survey.data$Bulls +
                       survey.data$Lone.Cows+
                       survey.data$Cow.W.1...calf*2+
                       survey.data$Cow.W.2.calves*3+
                       survey.data$Lone...calf+
                       survey.data$Unk.Age.Sex

ggplot(data=survey.data, aes(x=myNMoose, y=NMoose))+
  ggtitle("Compare my count vs. count on spreadsheet")+
  geom_point(position=position_jitter(h=.1,w=.1))+
  geom_abline(intercept=0, slope=1)
```


We count the number of observations by sub-unit and stratum
to ensure that *Stratum* has been coded properly. For example ensure that

-  stratum case is consistent (e.g. *h* vs. *H*), 
-  stratum codes are consistent (e.g. *H* vs. *HIGH*).

```{r echo=TRUE, message=TRUE, warning=TRUE}
xtabs(~Stratum, data=survey.data, exclude=NULL, na.action=na.pass)
```

We can also add additional computed variables. For example, the number of cows is found as
```{r echo=TRUE, message=FALSE, warning=FALSE}
survey.data$Cows <- survey.data$Lone.Cows + survey.data$Cow.W.1...calf + survey.data$Cow.W.2.calves
```

The first few records of the counts of interest are:
```{r echo=FALSE, message=FALSE, warning=FALSE}
head(as.data.frame(survey.data[,c("Block.ID","Stratum","Bulls","Lone.Cows","Cow.W.1...calf",
                    "Cow.W.2.calves","Cows","Lone...calf","Unk.Age.Sex","NMoose")]))
```

## Block area
The area of each surveyed block is also needed. 
```{r echo=TRUE, message=TRUE, warning=TRUE}
# Get the area of each block
survey.block.area <- readxl::read_excel(
                        system.file("extdata", "SampleMooseSurveyData.xlsx", package = "SightabilityModel", mustWork=TRUE),
                        sheet="BlockArea",
                        skip=1,.name_repair="universal")
head(survey.block.area)
```


The name of the variable identifying
the block should match the name used in the raw data from the previous section.
```{r echo=TRUE, message=FALSE, warning=FALSE}
names(survey.block.area)
names(survey.data)
```

Every block that is surveyed should have an area, but the block area file can have areas for blocks not surveyed (e.g. every block 
in the population of blocks). If a area is available for a block that was not surveyed, it is ignored.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Check that every surveyed block has an area. The setdiff() should return null.
setdiff(survey.data$Block.ID, survey.block.area$Block.ID)

# It is ok if the block area file has areas for blocks not surveyed
setdiff(survey.block.area$Block.ID, survey.data$Block.ID)
```


## Stratum information
Information about each stratum such as the total area and total number of blocks is required

```{r echo=TRUE, message=TRUE, warning=TRUE}
stratum.data <- readxl::read_excel(
      system.file("extdata", "SampleMooseSurveyData.xlsx", package = "SightabilityModel", mustWork=TRUE),
      sheet="Stratum",
      skip=2,.name_repair="universal")
stratum.data
```
Ensure that the stratum labels match those used in the raw data

## Sightability model.
A logistic regression comparing observed moose to known number of moose (e.g. how many radio collared moose
are detected) was used to estimate the sightability model. 

### Extracting from *AerialSurvey*
The sightability model used was extracted from the *AerialSurvey* program input files and entered on the
worksheet in the Excel workbook.
The *AerialSurvey* program uses two files to describe the survey (and computations) and the
model for the sightability.

The *Moose.mdf* is a text-file that describes the model used for sightability corrections.
A portion of the file is shown below

```
;==============================================================================
; MOOSE.MDF - Model description file (MDF) for Aerial Survey - 7-Oct-94
; -comments start with a semicolon (any text after it will be ignored)
; -blank value fields (right hand side) will default to nil, zero, or no!
;==============================================================================
[Model]
Title    = "Moose, Bell JetRanger"
Subtitle = '<Uses only the % veg cover>' ; optional
Species  = Moose
Aircraft = "Bell JetRanger"
Locale   = xxxxxx
Version  = 1.00
Terms    = 2           ; number of terms in the model, max = 10
Date     = 04.11.00
```

This appears to be the model for Bell JetRanger aircraft for moose.
The model for sightability appears to be function only of vegetation cover with two term
(intercept and vegetation cover class).

Vegetation cover appears to be divided into 6 classes:
```
[Transformations]
;Type of transformations can be:
;  Class, LookupT1, LookupT2, LookupT3, LookupT4, Table1, Table2, Power, None
Number = 1  ; number of transformations, max = 5
; for each transformation, give the name/index of the variable,
; and the type of transformation required on the variable
; TransformX = variable, type
Transform1 = VegCover, Class

[Class]  ; Class - e.g. vegetation cover classes into intervals
; for each interval give lower and upper limits and the assigned value
Intervals = 6  ; number of class intervals, max = 9
; ClassX = >lower, <=upper, value - ascending, sequential order
Class1 = -0.1,  20.0, 1.0
Class2 = 20.0,  40.0, 2.0
Class3 = 40.0,  60.0, 3.0
Class4 = 60.0,  80.0, 4.0
Class5 = 80.0,  100.0, 5.0
```
For example, if vegetation cover is from 0 to 20%, this is class 1; from 20%+ to 40% is class 2; etc.

The file also contains the estimated model coefficients and estimated covariance matrix for the sightability model..
```
; Map input variables into X's
[X] ; label/index from a list of variables
X01 = 1.0       ; constant
X02 = VegCover  ; class transformation

;------------------------------------------------------------------------------
; Model coefficients
;------------------------------------------------------------------------------
[Beta]   ; beta vector
Beta01 =  4.9604    ; constant
Beta02 = -1.8437    ; vegetation cover

[Sigma]  ; sigma matrix
Sigma01 =  0.7822
Sigma02 = -0.2820,  0.1115
```
The estimated probability of sighting a moose is
$$logit(p)=4.9604 -1.8437(vegetation~class)$$
Notice that vegetation class is used directly with values of 1 to 5 rather than as 5 indicator variables. 

### Reading coefficients of the model
The information from the *AerialSurvey* program was transferred to the
Excel workbook containing the survey information for this study.

The estimated coefficients of the model and the 
covariance matrix (sigma matrix) of the estimated coefficients are input

```{r echo=TRUE, message=FALSE, warning=FALSE}
# number of beta coefficients
nbeta <- readxl::read_excel(
   system.file("extdata", "SampleMooseSurveyData.xlsx", package = "SightabilityModel", mustWork=TRUE),
   sheet="SightabilityModel",
   range="B2", col_names=FALSE)[1,1,drop=TRUE]

# extract the names of the terms of the model
beta.terms <- unlist(readxl::read_excel(
     system.file("extdata", "SampleMooseSurveyData.xlsx", package = "SightabilityModel", mustWork=TRUE),
     sheet="SightabilityModel",
     range=paste0("B3:",letters[1+nbeta],"3"), 
     col_names=FALSE, col_type="text")[1,,drop=TRUE], use.names=FALSE)
cat("Names of the variables used in the sightability model:", beta.terms, "\n")
# extract the beta coeffiences
beta <- unlist(readxl::read_excel(
    system.file("extdata", "SampleMooseSurveyData.xlsx", package = "SightabilityModel", mustWork=TRUE),
    sheet="SightabilityModel",
    range=paste0("B4:",letters[1+nbeta],"4"), 
    col_names=FALSE, col_type="numeric")[1,,drop=TRUE], use.names=FALSE)
cat("Beta coefficients used in the sightability model:", beta, "\n")

# extract the beta covariance matrix
beta.cov <- matrix(unlist(readxl::read_excel(
    system.file("extdata", "SampleMooseSurveyData.xlsx", package = "SightabilityModel", mustWork=TRUE),
    sheet="SightabilityModel",
    range=paste0("B5:",letters[1+nbeta],4+nbeta), 
    col_names=FALSE, col_type="numeric"), use.names=FALSE), ncol=nbeta, nrow=nbeta)
cat("Beta covariance matrix used in the sightability model:\n")
beta.cov


```
These values match those in the *AerialSurvey* package.

The estimated sightability and expansion factors (inverse of sightability) are:
```{r echo=FALSE, message=FALSE, warning=FALSE}
Cover <- data.frame(intercept=1, VegCoverClass=1:5)
Cover$logit.p <- as.matrix(Cover[,1:nbeta ]) %*% beta
Cover$logit.p.se <- diag(sqrt( as.matrix(Cover[,1:nbeta ]) %*% beta.cov %*% t(as.matrix(Cover[,1:nbeta ]))))
Cover$p       <- 1/(1+exp(-Cover$logit.p))
Cover$p.se    <- Cover$logit.p.se * Cover$p * (1-Cover$p)
Cover$expansion <- 1/Cover$p
Cover$expansion.se <- Cover$p.se / Cover$p^2

temp <- Cover[, -1]
temp[,2:7]<- round(temp[,2:7],3)
#temp

kable(temp, row.names=FALSE,
      caption="Estimated sightability and expansion by Vegetation Cover Class",
      col.names=c("Vegetation Cover Class","logit(p)","SE logit(p)","p","SE(p)","Expansion Factor","SE(EF)")) %>%
      column_spec(column=c(1:7),         width="2cm") %>%
      kable_styling("bordered",position = "center", full_width=FALSE)


```

So a single moose sighted in Vegetation Cover Class 5 is expanded to almost 72 moose (!).


### Creation of *VegCoverClass* variable
We need to compute a *VegCoverClass* variable in the survey data. The *recode()* function
from the *car* package is used. 

```{r echo=TRUE, warning=FALSE, message=FALSE}
# convert the Veg Cover to Veg.Cover.Class

xtabs(~..Veg.Cover, data=survey.data, exclude=NULL, na.action=na.pass)
survey.data$VegCoverClass <- car::recode(survey.data$..Veg.Cover,
                                " lo:20=1; 20:40=2; 40:60=3; 60:80=4; 80:100=5")
xtabs(~VegCoverClass+..Veg.Cover, data=survey.data, exclude=NULL, na.action=na.pass)
```

Notice that there are 8 groups of moose where the *Vegetation Cover* was not recorded.
This has implications for estimation as noted later. Generally speaking,
you should not simply delete these observations because this will introduce
substantial bias in the estimates. Rather, impute a vegetation cover
class that gives the highest sightability for these groups to give a lower bound
on the number of moose in these groups. This will reduce (but not eliminate) the bias caused by simply dropping
these observations.




## Key variables.
There are several key variables used to match records across the raw data, block area, and stratum data frames. The 
default variable names are:

- *Block.ID* representing the block identification number. The *Block.ID* should not be duplicated in different
strata. It can be numeric or characters.
- *Block.Area* representing the area of each surveyed block. This should be numeric. 
- *Stratum* representing the stratum identification. It can be character or numeric does not have to be a single
character.
- *Stratum.Blocks* representing the total number of blocks in each stratum.      
- *Stratum.Area* representing the total area of each stratum in the same units as the *Block.Area*. 

The analysis function has arguments that can be changed if the names of these key variables differ from above.

## Dealing with missing and zero values

### Group information
For each group sighted, the number of animals is recorded and may be divided by age and/or sex groupings.
If no animals of a particular sex/age are seen in a group, then it should be recorded as zero rather than
as missing.

In some cases, sex/age information is not available for an animal. It should be counted in a separate category
for unknown sexed/aged animals. Of course the, a naive application of estimating the number of bulls may be biased
downwards is some bulls are recorded in the unknown sexed/aged category; however, estimates of the total
number moose will be fine.

No missing values are allowed in any count.

### Covariate information
The sightability models use covariates at the group level to adjust for detection less than 100%.
No missing values are allowed for the covariates. If the covariates are not available, then you 
should not simply delete the group, but rather impute a value of the covariate that gives the highest 
sightability to form a lower bound on the number of animals in the group.

See the example in the Sightability section below on dealing with missing covariates.

### Blocks with no observed groups.
It is possible that a block will be surveyed and NO animals seen in the entire block. In this case, you should
insert a "dummy" observation for this block with counts of 0 for the number of moose to ensure that
this surveyed block (with no animals seen) is properly accounted for.

### Block information
Each block must have a known area for the *MoosePopR()* function. Missing values are not allowed.

### A single block in a stratum
If a stratum has only a single block surveyed, then no design based estimate of variance
is possible. This is known as the *lonely primarly sampling unit (lonely PSU)*. Ad hoc
adjustments are possible; refer to
http://r-survey.r-forge.r-project.org/survey/exmample-lonely.html
for some suggestions.

The *MoosePopR()* function has an argument that can be set using
```
MoosePopR(...,  survey.lonely.psu="remove")
```
The the variance for this stratum is not considered when estimating the variance of the
grand totals or density. Unfortunately, it is not possible, at this time, to estimate
a ratio with some strata having lonely PSU. 

The *SightabilityPopR()* function can
deal with lonely PSUs by using within block variability (e.g. among groups) so this will provide a lower
bound to the true uncertaintly.

The bottom line is avoid designs where you sample only a single block in a stratum!

### Stratum information
Each stratum must have the known total area for the *MoosePop()* function and the
known total number of blocks for the *SightabilityPopR()* function.

# Analysis

## Analysis not adjusting for sightability 

### Within a stratum
#### Density
Suppose a sample of $n_h$ blocks were surveyed in stratum $h$. For each block, the number of moose $m_{hi}$
and the area of the block $a_{hi}$ are obtained for block $i$ in stratum $h$. The estimated density of moose per unit area 
in stratum $h$ is obtained as:
$$\widehat{D}_h = \frac{\sum_i m_{hi}}{\sum_i a_{hi}}$$
i.e. as the total number of moose in the surveyed blocks divided by the total survey area. This is a standard ratio estimator
and the estimated standard error is found as using equation 6.9 of Cochran (1977). The estimator and its standard error
can be automatically computed using the *svyratio()* function in the *survey* package (Lumley, 2019) of *R*.

#### Abundance
The estimated total number of moose in stratum $h$ ($\widehat{M}_h$) is  found by multiply the density estimate and its standard error by the stratum area
$A_h$

$$\widehat{M}_h = \widehat{D}_h  \times A_h$$
$$se(\widehat{M}_h) = se(\widehat{D}_h) \times A_h$$

#### Bull to Cow Ratio

Suppose a sample of $n_h$ blocks were surveyed in stratum $h$. For each block, the number of bulls $b_{hi}$
and the number of cows $c_{hi}$ are obtained for block $i$ in stratum $h$. The estimated bull to cow ratio
in stratum $h$ is obtained as:
$$\widehat{BC}_h = \frac{\sum_i b_{hi}}{\sum_i a_{hi}}$$
i.e. as the total number of bulls in the surveyed blocks divided by the total number of cows. This is a standard ratio estimator
and the estimated standard error is found as using equation 6.9 of Cochran (1977). The estimator and its standard error
are automatically computed using the *svyratio()* function in the *survey* package (Lumley, 2019) of *R*.

If the number of bulls per 100 cows is wanted, simply multiply the estimate and its standard error by 100x.

### Across all strata

#### Density
The overall density is found as a weighted averaged of the stratum specific densities:
$$\widehat{D}= \sum_h \frac{A_h}{\sum_h A_h}\widehat{D}_h$$

$$se(\widehat{D}) = \sqrt{\sum_h \left( \frac{A_h}{\sum_h A_h} \right)^2se(\widehat{D}_h)^2}$$

which is equivalent to the estimated total abundance (see below) divided by the total stratum area.
This is known as a *separate-ratio* estimator of the total and is possible because the expansion factor going from density to abundance (the stratum area) is known for each stratum.

#### Abundance
The total abundance is found by summing the estimated abundances across strata:

$$\widehat{M} = \sum_h \widehat{M}_h$$
and the standard error of the overall abundance is found as:
$$se(\widehat{M}) = \sqrt{\sum_h se(\widehat{M}_h)^2}$$
This is known as a *separate-ratio* estimator of the total and is possible because the expansion factor going from density to abundance (the stratum area) is known for each stratum.

#### Bull to Cow ratio
The estimation of the overall bull to cow ratio is computed using the
*double-ratio* estimate (Cochran, 1977, Section 6.19) as
$$\widehat{BC}_{\textit{double~ratio}}=\frac{\widehat{B}}{\widehat{C}}$$
where $\widehat{B}$ and $\widehat{C}$ are the estimated total number of bull and cows individually computed.
This is equivalent to the ratio of the overall density of bulls and cows. The above formula can be expanded to give

$$\widehat{BC}_{\textit{double~ratio}}=\frac{\sum_h \frac{\sum_i b_{hi}}{\sum_i a_{hi}} \times A_h}
                    {\sum_h \frac{\sum_i c_{hi}}{\sum_i a_{hi}} \times A_h}$$

Its standard error is NOT directly available in the *survey* package but is readily computed by finding the estimates
and the covariance of the estimates of number of bull and cows for each stratum and then using the delta method
to find the overall ratio and standard error of the overall ratio. 

### The *MoosePopR()* function.
A *MoosePopR()* function was created in *R* to replicate the results from *MoosePop*.
The key arguments to this function are:

- *survey.data* - information on each group measured in the survey. This was read from the Excel workbook earlier.
- *survey.block.area* - information about the area of each block surveyed. This was read from the Excel workbook earlier.
- *stratum.data* - information about each stratum. This was read from the Excel workbook earlier.
- *density, abundance, numerator, denominator* - variables for which the density, abundance, ratio are to be formed as right-sided formula (e.g. density=~Cows to estimate the density of Cows).
- *conf.level=0.90* indicates the  confidence 
level for confidence intervals to compute with the default being a 90% 
confidence interval.

### Sample Analyses
**Results differ slightly from those reported on an Excel spreadsheet because of slight differences
in areas of blocks between data provided to me and that used in MoosePop**.

We are now ready to do the analysis. I've gathered all of the analysis results into a list object
for extraction later.

**The *UC* suffix that I have placed on the estimate name indicates it is not corrected for sightability.**

#### Density of all moose

We compute the (uncorrected for sightability) density of all moose (regardless of sex or age) using the
number of moose (*NMoose*) variable. 

```{r echo=TRUE, message=TRUE, warning=TRUE}
result <- NULL
result$"All.Density.UC" <- MoosePopR(
      survey.data       = survey.data         # raw data
      ,survey.block.area = survey.block.area  # area of each block
      ,stratum.data      = stratum.data       # stratum information
      ,density=~NMoose                         # which density
)
result$"All.Density.UC"
```

The *estimate* and *SE* column as the estimated (uncorrected for sightability) 
density of all moose with a measure of uncertainty for
each stratum. The overall density is found as a weighted average (by stratum area) of the density in each stratum.

#### Abundance of all moose
We compute the estimated (uncorrected for sightability) abundance of all moose (regardless of sex or age)
by expanding the density by the *Stratum.Area*. The overall abundance is found
as the sum of the expanded estimates.

```{r echo=TRUE, message=FALSE, warning=FALSE}
result$"All.Abund.UC" <- MoosePopR(
      survey.data       = survey.data         # raw data
      ,survey.block.area = survey.block.area  # area of each block
      ,stratum.data      = stratum.data       # stratum information
      ,abundance=~NMoose                      # which density
)
result$"All.Abund.UC"
```
The *estimate* and *SE* column as the estimated (uncorrected for sightability) 
density of all moose with a measure of uncertainty for
each stratum. The overall abundance is found as the sum of the estimates in each stratum (*WF* is missing).

#### Number of bulls and number of cows

We estimate the (uncorrected for sightability) abundance of Bulls and Cows.

```{r echo=TRUE, message=FALSE, warning=FALSE}
result$"Bulls.Abund.UC" <- MoosePopR(
      survey.data       = survey.data         # raw data
      ,survey.block.area = survey.block.area  # area of each block
      ,stratum.data      = stratum.data       # stratum information
      ,abundance=~Bulls                      # which density
)
result$"Bulls.Abund.UC" 
  
result$"Cows.Abund.UC" <- MoosePopR(
      survey.data       = survey.data         # raw data
      ,survey.block.area = survey.block.area  # area of each block
      ,stratum.data      = stratum.data       # stratum information
      ,abundance=~Cows                      # which density
)  
result$"Cows.Abund.UC"
```
These values are computed similarly as the total abundance.

#### Bull to Cow ratio
Finally, we estimate the Bulls:Cows ratio:

```{r echo=TRUE, message=FALSE, warning=FALSE}
result$"Bulls/Cow.UC" <- MoosePopR(
      survey.data       = survey.data         # raw data
      ,survey.block.area = survey.block.area  # area of each block
      ,stratum.data      = stratum.data       # stratum information
      ,numerator=~Bulls, denominator=~Cows    # which density
) 
result$"Bulls/Cow.UC"
```

#### Final object
```{r echo=TRUE, warning=FALSE, message=FALSE}
names(result)
```


## Adjusting for sightability
The above computations are not adjusted for sightability, i.e. not all moose
can be detected due to visibility concerns. 

An adjustment for sightability can be done by also performing a study where a known 
number of moose (e.g. radio collared) are surveyed and information about detection/non detection
is recorded. A logistic regression (see previous sections) is used to estimate the
probability of detection given covariates (such as Vegetation Class). 

Then the sightability model is used to expand the observed number of moose seen in a group by the
inverse of the probability of detection. For example, if the probability of detection for
a group is 0.4, then each moose in the group is expanded by $1/0.4=2.5x$ to account for
sightability. It is assumed that all animals in a group (e.g. bulls, cows, calves) have the
same sightability correction factor.

Let $\theta_{hjk}$ represent the expansion factor for group $k$ in block $j$ of stratum $h$.
In the analyses that follow the block area is NOT used in the analysis. In its place, a simple
expansion based on the number of blocks surveyed within a stratum are used. This will be less
efficient (i.e. have a larger standard error) compared to an analysis that uses the individual
block areas, but unless there is a high correlation between the number of animals and the block area,
the loss of efficiency is small. If all blocks had the same area, the two approaches are identical.

We examined the correlation for the existing survey data and it is typically small.
Cochran (1977) shows that unless the correlation is larger than a specified cutoff
that depends on the coefficient of variation of the numerator and denominator variables,
then there is no gain in using the block area.
```{r echo=FALSE,message=FALSE, warning=FALSE}
# Look at correlations between total number of moose, bulls, and cows and block area
survey.block.data <- plyr::ddply(survey.data, 
                                 c("Block.ID","Stratum"),
                                 plyr::summarize,
                                 Bulls          = sum(Bulls,           na.rm=TRUE),
                                 Lone.cows      = sum(Lone.Cows,       na.rm=TRUE),
                                 Cow.W.1...calf = sum(Cow.W.1...calf,  na.rm=TRUE),
                                 Cow.W.2.calves = sum(Cow.W.2.calves,  na.rm=TRUE),
                                 Lone...calf    = sum(Lone...calf,     na.rm=TRUE),
                                 Unk.Age.Sex    = sum(Unk.Age.Sex,     na.rm=TRUE),
                                 Cows           = sum(Cows,            na.rm=TRUE),
                                 NMoose         = sum(NMoose,          na.rm=TRUE))
# add the area to the block totals
survey.block.data <- merge(survey.block.data, survey.block.area, all.x=TRUE)

# What is correlation between block area and number of moose etc
survey.block.data.melt <- reshape2::melt(survey.block.data,
                        id.vars=c("Stratum","Block.ID","Block.Area"),
                        measure.vars=c("Bulls","Lone.cows","Cow.W.1...calf","Cow.W.2.calves",
                                       "Lone...calf","Unk.Age.Sex","Cows","NMoose"),
                        variable.name="Classification",
                        value.name="N.Animals")

# find correlation between number of animals and area
res <- plyr::ddply(survey.block.data.melt, c("Stratum","Classification"), plyr::summarize,
                   corr=cor(N.Animals, Block.Area),
                   cv.N.Animals=sd(N.Animals)/mean(N.Animals),
                   cv.Area     =sd(Block.Area)/mean(Block.Area),
                   cut.off      = cv.Area/2/cv.N.Animals)

temp <- res[,c(1,2,3,6)]
temp[,3:4] <- round(temp[,3:4],2)
kable(temp, row.names=FALSE,
      caption="Estimated correlation between animal counts and block area",
      col.names=c("Stratum","Type of Animal","Corr","Cutoff")) %>%
      column_spec(column=c(1:2),         width="3cm") %>%
      column_spec(column=c(3:4),         width="1cm") %>%
      kable_styling("bordered",position = "center", full_width=FALSE)

```
The correlations are not high and rarely exceed the cutoff where using block area would be beneficial.
Of course, this also does not account for sightability issues. 

A plot of the two variables for each types of animals shows no strong relationship between 
the number of observed animals and the block area:

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data=survey.block.data.melt, aes(x=Block.Area, y=N.Animals, color=Stratum))+
  geom_point()+
  facet_wrap(~Classification, ncol=3, scales="free")+
  theme(legend.position=c(1,0), legend.justification=c(1,0))
```

Consequently, it not expected that ignoring block area in the analysis will have
a material effect.

### Within a stratum
#### Abundance
Suppose a sample of $n_h$ blocks were surveyed in stratum $h$ out of $N_h$ total number of blocks. 
For each block, the number of moose $m_{hjk}$
are obtained for group $k$ in block $j$ in stratum $h$. The
estimated correction factor (for visibility) is of animals in this group is 
$\widehat{\theta}_{hjk}$.

The estimated abundance of moose in stratum $h$ is obtained as:
$$\widehat{M}_h = N_h \times \frac{\sum_{jk} m_{hjk}\widehat{\theta}_{hjk}}{n_h}$$
i.e. as the mean number of moose per surveyed block times the total number of blocks. The
standard error of this estimate is complicated because of the need to account for the estimated sightability
but the theory is covered in Steinhurst and Samuel (1989), Fieberg (2012) and Wong (1996) and
implemented in the *AerialSurvey* and *SightabiityModel* packages of *R*. The latter 
package corrects the variance computations used by Steinhurst and Samuel (1989) and Fieberg (2012).

#### Density
The estimated density of moose in stratum $h$ ($\widehat{D}_h$) is 
found by dividing the abundance estimate and its standard error by the stratum area
$A_h$

$$\widehat{D}_h = \frac{\widehat{M{_h}}}{A_h} $$
$$se(\widehat{M}_h) = \frac{se(\widehat{M}_h)}{A_h}$$

#### Bull to Cow ratio
The ratio of bulls to cows within a stratum is computed as the estimated abundances in each stratum:
$$\widehat{BC}_h = \frac{\widehat{Bulls}_h}{\widehat{Cows}_h}$$
i.e. as the estimated total number of bulls in the stratum
divided by the estimated total number of cows. This ratio estimator is not available
in the *SightabilityModel* package, but a new function was written and added to the package to
add this functionality. The standard error is difficult to compute because of the need to 
account for the correlation between the number of bulls and moose in individual groups and the
the uncertainty of the correction factors but is given in Wong (1996).

Note that if the sightability is equal for all groups, then this common sightability correction
factor would cancel everywhere and you would get the same results as the ratio estimator based
on the observed counts. In most cases, the impact of sightability will be small on the ratio estimator
and its standard error.

If the number of bulls per 100 cows is wanted, simply multiply the estimate and its standard error by 100x.

### Across all strata
#### Abundance
The total abundance is found by summing the estimated abundances across strata:

$$\widehat{M} = \sum_h \widehat{M}_h$$
The standard error is difficult to compute because the same sightability model is used across strata. 
This has been implemented in the *SightabilityModel* package and the *AerialSurvey* program.

#### Density
The overall density and its standard error 
is found as estimated total abundance and its standard error
divided by the total area over all strata..
$$\widehat{D}= \frac{ \widehat{M}}{\sum_h A_h}$$
$$se(\widehat{D}) =  \frac{se(\widehat{M})}{{\sum_h A_h}}$$
Because the total area of all strata is known quantity, this is straightforward.


#### Bull to Cow ratio
The estimation of the overall bull to cow ratio is computed as the ratios of their respective estimated
abundances
$$\widehat{BC}=\frac{\widehat{Bulls}}{\widehat{Cows}}$$
This ratio estimator was not available in the *SightabilityModel* package, but its functionality has been added
as part of this contract. Standard errors are computed as described in Wong (1996).

### The *SightabilityPopR()* function
I have created a function with the same calling arguments as the *MoosePopR()* function to
estimate abundance, density, and ratios using the *SightabiityModel* package. 
Notice that additional functionality was added to the *SightabilityModel* package to estimate ratios.


A *SightabilityPopR()* function has a similar calling sequence as the *MoosePopR* function with 
the same key input variables.

- *survey.data* - information on each group measured in the survey. This was read from the Excel workbook earlier.
- *survey.block.area* - information about the area of each block surveyed. This was read from the Excel workbook earlier.
- *stratum.data* - information about each stratum. This was read from the Excel workbook earlier.
- *density, abundance, numerator, denominator* - variables for which the density, abundance, ratio are to be formed as right-sided formula (e.g. density=~Cows to estimate the density of Cows).
- *conf.level=0.90* indicates the  confidence 
level for confidence intervals to compute with the default being a 90% 
confidence interval.

Additionally, the sightability formula, the beta coefficients and the estimated covariance matrix
must also be specified using the arguments:

- *sight.formula* - the formula for the sightability model. This should use the variables in the *survey.data* frame
- *sight.beta* - the beta coefficients for the sightability model
- *sight.beta.cov* - the covariance matrix for the beta coefficients
- *sight.logCI* - should confidence intervals for abundance be computed using a logarithmic transformation
- *sight.var.method* - what method should be used to estimate the variances (either the methods of Wong (1996) or Steinhurst
and Samuels (2012). 

These additional parameters are passed to the appropriate functions in the *SightabilityModel* package. Refer to
the examples for details.
 
### Sample Analyses
#### Dealing with missing values in the sightability covariates
Because we are correcting for sightability, we need the *VegClassCover* for all groups. However
there are some groups of moose with missing data for this covariate:
```{r echo=TRUE, message=FALSE, warning=FALSE}
select <- is.na(survey.data$VegCoverClass)
survey.data[select,]
```
If you simply delete these observations, then estimates can be severely biased because these groups
would be excluded from the expansions when corrected for sightability. About the best that can be done is
to assign an imputed vegetation class to these observations with the highest sightability to reduce the
bias.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# change the missing values to cover class with highest sightability
survey.data$VegCoverClass[select] <- 1
survey.data[select,]

```


We are now ready to do the analysis. I've gathered all of the analysis results into a list object
for extraction later.

**The *C* suffix that I have placed on the estimate name indicates it is  corrected for sightability.**

Here are the results from the sample analyses

#### Abundance of all moose
We compute the (corrected for sightability) abundance of all moose (regardless of sex or age) using the
number of moose (*NMoose*) variable. 

```{r echo=TRUE, message=TRUE, warning=TRUE}
result <- NULL
result$"All.Abund.C" <- SightabilityPopR(
      survey.data       = survey.data         # raw data
      ,survey.block.area = survey.block.area  # area of each block
      ,stratum.data      = stratum.data       # stratum information
      ,abundance=~NMoose                      # quantifies to estimate
      ,sight.formula     = observed ~ VegCoverClass # sightability mode;
      ,sight.beta        = beta                     # the beta coefficients for the sightability model
      ,sight.beta.cov    = beta.cov                 # the covariance matrix for the beta coefficients
      ,sight.var.method  = "Wong"                   # method  used to estimate the variances 
)
temp <- result$"All.Abund.C"
temp[,-c(1:3,8)] <- round(temp[,-c(1:3,8)]+.00001,0)  # force to be numeric
temp
```
The *estimate* and *SE* column as the estimated (corrected for sightability) density of all moose with a measure of uncertainty for
each stratum. The overall abundance is found as the sum of the estimates in each stratum. The right most columns
are information about the sources of uncertainty (due to sampling, sightability, or the model for sightability).

We can show the impact of simply deleting those values missing the *VegCoverClass* covariate by
setting the observed values of moose to .001 for these groups. This will retain the correct number
of blocks surveyed. If you simply deleted those groups of moose with missing *VegCoverClass* values
and a block then had no observations, the block would 
"disappear" from the analysis which is not correct.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# mimic impact of deleting observations with missing VegCoverClass
survey.data2 <- survey.data
survey.data2$NMoose[select] <- .001
wrong.way <- SightabilityPopR( # show impact of deleting observations but keeping # blocks the same
      survey.data        = survey.data2         # raw data
      ,survey.block.area = survey.block.area  # area of each block
      ,stratum.data      = stratum.data       # stratum information
      ,abundance=~NMoose                      # quantifies to estimate
      ,sight.formula     = observed ~ VegCoverClass # sightability mode;
      ,sight.beta        = beta                     # the beta coefficients for the sightability model
      ,sight.beta.cov    = beta.cov                 # the covariance matrix for the beta coefficients
      ,sight.var.method  = "Wong"                   # method  used to estimate the variances 
)
wrong.way
```
Notice the negative bias in the estimated abundance computed the incorrect way
(`r round(wrong.way[wrong.way$Stratum==".OVERALL","estimate"])`) vs. the value
when the *VegCoverClass* is set to the class with hight sightability 
(`r round(result$"All.Abund.C"[result$"All.Abund.C"$Stratum==".OVERALL","estimate"])`) computed above.

#### Density of all moose

We compute the estimated (corrected for sightability) density of all moose (regardless of sex or age).


```{r echo=TRUE, message=FALSE, warning=FALSE}
result$"All.Density.C" <- SightabilityPopR(
      survey.data       = survey.data         # raw data
      ,survey.block.area = survey.block.area  # area of each block
      ,stratum.data      = stratum.data       # stratum information
      ,density=~NMoose                      # quantifies to estimate
      ,sight.formula     = observed ~ VegCoverClass # sightability mode;
      ,sight.beta        = beta                     # the beta coefficients for the sightability model
      ,sight.beta.cov    = beta.cov                 # the covariance matrix for the beta coefficients
      ,sight.var.method  = "Wong"                   # method  used to estimate the variances 
)
temp<- result$"All.Density.C"
temp[,-(1:3)] <- round(temp[,-(1:3)]+.00001,2)  # force to be numeric
temp
```

The *estimate* and *SE* column as the estimated (corrected for sightability) 
density of all moose with a measure of uncertainty for
each stratum. The overall density is found as a estimated abundance/total area over all strata. The variance components are
the same for the total abundance because these values are used to derive the density.


#### Number of bulls and number of cows
We estimate the (corrected for sightability) abundance of Bulls and  cows.


```{r echo=TRUE, message=FALSE, warning=FALSE}
result$"Bulls.Abund.C" <- result$"All.Density.C" <- SightabilityPopR(
      survey.data       = survey.data         # raw data
      ,survey.block.area = survey.block.area  # area of each block
      ,stratum.data      = stratum.data       # stratum information
      ,density=~Bulls                      # quantifies to estimate
      ,sight.formula     = observed ~ VegCoverClass # sightability mode;
      ,sight.beta        = beta                     # the beta coefficients for the sightability model
      ,sight.beta.cov    = beta.cov                 # the covariance matrix for the beta coefficients
      ,sight.var.method  = "Wong"                   # method  used to estimate the variances 
)
result$"Bulls.Abund.C"

result$"Cows.Abund.C" <- SightabilityPopR(
      survey.data       = survey.data         # raw data
      ,survey.block.area = survey.block.area  # area of each block
      ,stratum.data      = stratum.data       # stratum information
      ,density=~Cows                      # quantifies to estimate
      ,sight.formula     = observed ~ VegCoverClass # sightability mode;
      ,sight.beta        = beta                     # the beta coefficients for the sightability model
      ,sight.beta.cov    = beta.cov                 # the covariance matrix for the beta coefficients
      ,sight.var.method  = "Wong"                   # method  used to estimate the variances 
)
result$"Cows.Abund.C"
```
These values are computed similarly as the total abundance.

#### Bull to Cow ratio
Finally we estimates the Bulls/Cow ratio using the corrected for sightability values.

```{r echo=TRUE, message=FALSE, warning=FALSE}
result$"Bulls/Cow.C" <- SightabilityPopR(
      survey.data       = survey.data         # raw data
      ,survey.block.area = survey.block.area  # area of each block
      ,stratum.data      = stratum.data       # stratum information
      ,numerator=~Bulls, denominator=~Cows                      # quantifies to estimate
      ,sight.formula     = observed ~ VegCoverClass # sightability mode;
      ,sight.beta        = beta                     # the beta coefficients for the sightability model
      ,sight.beta.cov    = beta.cov                 # the covariance matrix for the beta coefficients
      ,sight.var.method  = "Wong"                   # method  used to estimate the variances 
)
  
temp<- result$"Bulls/Cow.C"
temp[,-(1:3)] <- round(temp[,-(1:3)]+.00001,3)  # force to be numeric
temp
```

The ratio is computed within each stratum and overall
The sources of variation computations are set to missing as they are not sensible in this case.

Notice that this ratio estimator is not that different from that computed from values uncorrected
for sightability. This is a consequence of the approximately equal sightability correction factor
for all groups.


#### Final object
The result is a list object with one element each of the analyses done above.
```{r echo=TRUE, message=FALSE, warning=FALSE}
names(result)
```



# References
Cochran, W.G. (1977). Sampling techniques. 3rd Edition. Wiley. New York.

Fieberg, J. (2012). Estimating Population Abundance Using Sightability Models: R SightabilityModel Package. Journal of Statistical Software, 51(9), 1-20. URL http://www.jstatsoft.org/v51/i09/.

Lumley, T. (2019) "survey: analysis of complex survey samples". R package version 3.35-1.

R Core Team (2019). R: A language and environment for statistical computing. R Foundation for Statistical Computing,
  Vienna, Austria. URL https://www.R-project.org/.

Steinhorst, K. R. and Samuel, M. D. (1989). Sightability Adjustment Methods for Aerial Surveys of Wildlife Populations. Biometrics 45:415â€“425.

Wong, C. (1996). Population size estimation using the modified Horvitz-Thompson estimator with estimated sighting probabilities. Dissertation, Colorado State University, Fort Collins, USA.

